\documentclass[twoside,english]{uiofysmaster/uiofysmaster}

\usepackage[toc,titletoc,title,page]{appendix} %to add appendices (and have them in toc)
\usepackage[utf8]{inputenc}
%\usepackage{mhchem} %latex chemistry symbols
\usepackage{blindtext} %to fill in dummy text
%\usepackage{cite} %to have multiple citations in one \cite{key1,key2,..} -do not use with natbib!!
\usepackage{tcolorbox} %to have boxes w color around text and math mode
\usepackage{enumitem} %to reduce vertical spacing in enumerate
\usepackage{tabu} % to set tables to page width
%\usepackage{aas_macros}

\usepackage[sort&compress,square,comma,numbers]{natbib} %to use \citet, now mixed with [nr]
\usepackage[nottoc]{tocbibind}

\usepackage{float} 
\usepackage{pdfpages}

\interfootnotelinepenalty=10000 % to force footnotes to NOT run over to the next page

%---
% to reduce space around table of contents (to fit everything into one page): 
\usepackage{tocloft}
\setlength{\cftbeforetoctitleskip}{0pt}
\setlength{\cftaftertoctitleskip}{0pt}
%---

\usepackage{epigraph}
\setlength\epigraphwidth{11cm}
\setlength\epigraphrule{0pt}

%---
\newcommand{\Sm}{$^{140}$Sm} % making it faster to write Sm140
\newcommand{\Pb}{$^{208}$Pb} 
\newcommand{\bd}{$\beta$-decay} % making it faster to write 
\newcommand{\ga}{$\gamma$}

%---
% modifying color in code listings and some style
%\usepackage{color}

% The predefined color names are: 
% black, blue, brown, cyan, darkgray, gray, green, lightgray, lime, magenta, olive, orange, pink, purple, red, teal, violet, white, yellow.
 
%\definecolor{codegreen}{rgb}{0,0.6,0} % too flashy
\definecolor{codegreen}{rgb}{0.0, 0.42, 0.24} % less flashy so comments not take all attention
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
%\definecolor{codepurple}{rgb}{1.0, 0.0, 0.22} %carminered, could try it 
%\definecolor{backcolour}{rgb}{0.95,0.95,0.92} % original suggestion
\definecolor{backcolour}{rgb}{0.94, 0.97, 1.0}% aliceblue, not so flashy and not as ugly
\definecolor{LightGray}{gray}{0.95}
 
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    %commentstyle=\color{codegray},    
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    %numbers=left,     %removing line numbers in the code snippets               
    %numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    %float=tp,
    %floatplacement=tbp
}
 
\lstset{
	style=mystyle,
	literate={~} {$\sim$}{1}
}
\renewcommand{\lstlistingname}{Code}
%---

%---
% new tcolorbox environment
% #1: tcolorbox options
% #2: color
% #3: box title
\newtcolorbox{mybox}[3][]
{
  colframe = #2!25,
  colback  = #2!10,
  coltitle = #2!20!black,  
  title    = #3,
  #1,
}

%---


%\bibliography{references}

\author{Trond Wiggo Johansen}
\title{Coulomb excitation of $\textnormal{\Sm}$}
\date{May 2019}
 
% ----------------------------------------------------------------------------------------------------------------------
% ----------------------------------------------------------------------------------------------------------------------
%Equations
%
%The command \eqref{} works exactly like \ref{}, but it adds parantheses to a plain number.
%
%Figures and tables
%
%\autoref{} is a usefull command when refering to to figures and tables. The command creates a reference with additional text corresponding to the target's type. For example, the command \autoref{fig:myfigure} would create a hyperlink to the \label{fig:myfigure} command, wherever it is. Assuming that this label is pointing to a figure, the hyperlink would contain the text "Figure 1.1", or similar.

%Two basic citation commands, \citet and \citep for textual and parenthetical citations, respectively. …
%\citet{jon90} --> Jones et al. (1990)
%\citep{jon90} --> (Jones et al., 1990)
%\citet*{jon90} --> Jones, Baker, and Williams (1990)
%\citep*{jon90} --> (Jones, Baker, and Williams, 1990)


\begin{document}

% set space around equations
\setlength{\belowdisplayskip}{12pt} \setlength{\belowdisplayshortskip}{12pt}
\setlength{\abovedisplayskip}{12pt} \setlength{\abovedisplayshortskip}{12pt}

\maketitle

%Centering the front page, see: https://github.com/ComputationalPhysics/uiofysmaster

%%% ABSTRACT
\begin{abstract}


\end{abstract}


\begin{dedication}
To my family, for all their support and encouragement!

\end{dedication}

\begin{acknowledgements}
Supervisors Andreas Görgen and Katarzyna Hady\'nska-Kl\c ek

Nuclear Physics Group

Computational Physics Group, Morten Hjorth-Jensen

CERN-ISOLDE, Liam Gaffney

Lillefy, FFU, Fysikkforeningen

My family

Morten, Alex and Astrid.

Ina, for pushing me towards excellence, I love you.

\subsection*{Collaboration details}
The sorting and analysis code used in this thesis has been developed at CERN-ISOLDE and can be found at \url{https://github.com/Miniball/MiniballCoulexSort}

The code for theoretical predictions of energy used in the calibration was developed by Liam Gaffney who is working at ISOLDE and has to do with analysis of data from Miniball and ISS. kinsim can be found here \url{https://github.com/lpgaff/kinsim}

Some calibration code is based on the codes of Ville Virtanen and Liam Gaffney. 

Other code/scripts have been written by the author. C++ / Python.

  \vspace{1.5cm}
  
  \noindent\textit{Trond Wiggo Johansen}\\
  
  \noindent September, 2019
  
\end{acknowledgements}


\tableofcontents


% ----------------------------------------------------------------------------------------------------------------------
% ----------------------------------------------------------------------------------------------------------------------

\chapter{Introduction}

kinsim \cite{kinsim}

The experiment has been done before, with lower energy (and another target), Malin Klintefjord. \url{http://urn.nb.no/URN:NBN:no-56121} \newline
 
 
Experiment conducted 8th - 14th of August 2017.
% ----------------------------------------------------------------------------------------------------------------------
% ----------------------------------------------------------------------------------------------------------------------

\chapter{Motivation / Theory?}

Quadrupole deformation of nuclei. \newline

Shape coexistence possible for certain regions of $N$ and $Z$.

\bigskip

- triaxial shape / shape coexistence \newline
- benchmark for theoretical models \newline
- transition probabilities and quadrupole moments between several excited states are not known \newline
- fundamental research

% ----------------------------------------------------------------------------------------------------------------------
% ----------------------------------------------------------------------------------------------------------------------


\chapter{Coulomb excitation experiment} 
\textcolor{red}{Table of abbreviations and symbols?}

\begin{table}[H]
  \centering
  \caption{Acronyms and abbreviations.}
    \begin{tabular}{ll}
        \hline
        ADC & Analog to Digital Converter \\
        CERN & European Council for Nuclear Research \\ 
         & (in French Conseil Européen pour la Recherche Nucléaire) \\
        Coulex & Coulomb excitation \\
        EBIS & Electron Beam Ion Source \\
        ENSAR2 & European Nuclear Science and Applications Research - 2 \\
        GPS & General Purpose Separator \\
        HIE-ISOLDE & High Intensity and Energy upgrade of ISOLDE \\
        HRS & High Resolution Separator \\
        ISOL & Isotope Separator On Line \\
        ISOLDE & ISOL DEvice \\
        Linac & Linear accelerator \\
        PSB & Proton Synchrotron Booster \\
        REXEBIS & Radioactive beam EXperiment EBIS \\
        RIB & Radioactive Ion Beam \\
        RILIS & Resonance Ionization Laser Ion Source \\
        TDC & Time to Digital Converter (or time digitizer) \\
        \hline
    \end{tabular}
    \label{tab:acro}
\end{table}


\textbf{Information sources:}
\begin{itemize}  
\item CD: \url{https://www.ikp.uni-koeln.de/~warr/doc/cd.pdf}
\item Why CoulEx? \url{https://iks32.fys.kuleuven.be/wiki/brix/images/5/58/10_20151123_Illana_BriX15_web.pdf}
\item 2017: \url{https://iopscience.iop.org/article/10.1088/1361-6471/aa5c4e#jpgaa5c4es2}
\item 2017: \url{http://iopscience.iop.org/article/10.1088/1361-6471/aa990f/pdf}
\item \url{http://publications.lib.chalmers.se/records/fulltext/175494/local_175494.pdf}
\item \url{https://www.euroschoolonexoticbeams.be/site/files/nlp/LNP700_contrib2.pdf}
\item 2004: \url{http://accelconf.web.cern.ch/AccelConf/e04/PAPERS/TUXCH01.PDF}
\item 2003: \url{https://ac.els-cdn.com/S0168583X02018864/1-s2.0-S0168583X02018864-main.pdf?_tid=64f42a8d-b37c-42a6-a3c5-f01dcee73366&acdnat=1545049646_8918b985af428e17c9741f7142fe0e36} 
\item 2002: \url{https://ac.els-cdn.com/S0168900201009548/1-s2.0-S0168900201009548-main.pdf?_tid=71a410a3-6554-4268-ac1a-1b43cae4039d&acdnat=1545056166_15ff5318affd89c7e63f819c9229a9e9}
\end{itemize}




\bigskip

- nucleus excited by electromagnetic interaction. \newline
- de-excitation $\rightarrow$ gamma



\textcolor{red}{---------} \newline
\textcolor{red}{Oppgavens mål:} \newline
The ISOLDE facility at CERN has been upgraded to provide higher energies and intensities for radioactive ion beams. A new experiment to study 140Sm was performed in the summer of 2017. The goal of the experiment was to measure electromagnetic transition probabilities and electric quadrupole moments for several excited states in 140Sm by measuring Coulomb excitation probabilities. A large data set was obtained using silicon detectors to determine the energies and angles of scattered particles, and germanium detectors to measure gamma rays from excited states in 140Sm. \newline

The goal of the master thesis is to analyze the data from this experiment. The required tasks include development and improvement of data analysis software to determine Coulomb excitation yields. These yields will then, in a second step, be compared to theoretical calculations and transition probabilities and quadrupole moments will be extracted using chi-square minimization procedures. \newline


\textcolor{red}{Prosjektbeskrivelse (omfang 60 studiepoeng):} \newline
The shape of an atomic nucleus is determined by a delicate interplay between macroscopic (liquid drop) properties and microscopic shell effects. Nuclei with filled proton or neutron shells (i.e. magic nuclei) are generally spherical in shape, whereas nuclei with open shells gain energy by assuming a deformed shape. Depending on the occupation of specific orbitals, the nuclear shape can change drastically by adding or removing protons or neutrons. Certain nuclei exhibit shape coexistence, i.e. the coexistence of quantum states that correspond to different shapes. Because the shape of a nucleus is so sensitive to the underlying nuclear structure and to changes of the proton and neutron numbers, the excitation energy, or the angular momentum, observables related to the nuclear shape are used as benchmarks for theoretical models. 

Nuclei in the rare earth region, and in particular the chain of samarium isotopes, exhibit a variety of shape effects. The Sm isotope with closed neutron shell at N=82, 144Sm, is spherical in shape. Adding neutrons to 144Sm changes the deformation to an elongated (prolate) quadrupole shape. The transition from spherical to prolate shape, which occurs for 152Sm at N=90, can be interpreted as a shape-phase transition. Flattened (oblate) quadrupole shapes are predicted by theory to occur below the N=82 shell closure. An earlier experiment studying 140Sm at CERN-ISOLDE found triaxial shape for this isotope, i.e. a shape where all three principal axes of the ellipsoid have different lengths. 140Sm can therefore be considered to lie at the critical point of a phase transition from spherical to deformed, and from prolate to oblate shape. \newline

\textcolor{red}{Foreløpig tittel:} \newline
Coulomb excitation of 140Sm \newline


\textcolor{red}{Metoder som tenkes benyttet:} \newline
Multi-step Coulomb excitation with radioactive beam, isotope separation on-line technique, nuclear spectroscopy, particle-gamma and particle gamma-gamma coincidence analysis, advanced chi-square minimization procedures. \newline
\textcolor{red}{---------} \newline


\section{ISOLDE at CERN}
ISOLDE is a radioactive ion beam facility at CERN in Meyrin, Switzerland. \autoref{fig:accelerators} shows the CERN accelerator complex \cite{CERN-AC}, where ISOLDE is located beside the PS BOOSTER (PSB). The facility can produce over 1000 different radionuclides to be used in a wide variety of experiments in nuclear physics, atomic physics, solid state physics, life sciences and fundamental interactions. Experiments have been performed at ISOLDE since 1967 and since 2001 experiments with post-accelerated radioactive ion beams (RIBs) have been conducted. The high intensity and energy upgrade (HIE-ISOLDE) have made it possible to deliver energies up to 10 MeV/$u$ in 2018 \cite{HIE-ISOLDE, ISOLDE-web, ISOLDE-facility}. 

\begin{figure}[t]
	\centering
	\includegraphics[width=\textwidth]{images/0812015.pdf}
	\caption{The CERN accelerator complex. ISOLDE gets accelerated protons from LINAC 2 and the PS BOOSTER.}
	\label{fig:accelerators}
\end{figure}


\subsection{Beam production}

ISOLDE experimental hall (\textcolor{red}{make flow chart or show overview over the hall}):
\begin{align*}
	\text{p}^+ ~(\text{from PSB}) \rightarrow~ &\text{Production target} \rightarrow \text{GPS} \rightarrow \text{RILIS} \rightarrow \text{\textcolor{red}{REXTRAP?}} \rightarrow \\
 &\text{REXEBIS} \rightarrow \text{HIE-ISOLDE} \rightarrow \text{MINIBALL}
\end{align*}



A proton beam of 1.4 GeV ($\sim 10^{18}$ protons) from the PSB comes into the ISOLDE facility and collide with a production target \textcolor{purple}{of tantalum, producing the elements in the chart of nuclides up to tantalum. The proton beam can collide in one of the two target stations, the general purpose separator (GPS) or the high resolution separator (HRS). The GPS has one bending magnet and can deliver beams of different mass simultaneously into three beam lines, while the HRS has two bending magnets with high mass resolving power and deliver the beam into the main \textcolor{teal}{(or common)} beam line. In this experiment, the GPS was used.} The fragments travels in the beam line onward to the GPS where the isobar of with mass number $A = 140$ is selected (\textcolor{red}{separated from the rest}). 

\textcolor{red}{GPS or RILIS first??}

\textcolor{red}{RILIS or REXEBIS for ionization of the atom?} 

The resonance ionization laser ion source (RILIS) uses the method of step-wise excitation and ionization of the atom. \textcolor{red}{It is a three step excitation, where the last step leads to the ionization.}  \textcolor{teal}{RILIS selects samarium with laser (element selective process, samarium $Z = 62$). RILIS is used to produce ion beams \textcolor{purple}{of the correct element}.}

\textcolor{red}{REXTRAP}. Penning trap

REXEBIS excites the nucleus in three steps ionizing the atom, which leaves the nucleus in a high charge state. 

The HIE-linac accelerates the beam through the beam line and magnets bend the beam into MINIBALL. 

\textcolor{red}{Cite: \url{https://ac.els-cdn.com/0168583X92959079/1-s2.0-0168583X92959079-main.pdf?_tid=0ccb0647-5870-48f9-ac38-df8c0077981c&acdnat=1545216224_d359ddcc40ea1f94369c85a141edba63} and \url{https://cds.cern.ch/record/2025701/files/epjconf_inpc2013_11005.pdf} and \url{http://isolde.web.cern.ch/targets-and-separators}}

\bigskip

\textcolor{red}{"The General Purpose Separator (GPS) has one bending magnet and an electrostatic switchyard allowing the simultaneous extraction of three mass separated beams." \url{http://isolde.web.cern.ch/targets-and-separators}}

\bigskip

ISOLDE GPS++ \url{https://cds.cern.ch/record/2025701/files/epjconf_inpc2013_11005.pdf}

\bigskip


\textcolor{red}{"The RILIS is a chemically selective ion source which relies on resonant excitation of atomic transitions using tunable laser radiation." \url{http://rilis.web.cern.ch}} 

\textcolor{red}{"The principal application of RILIS is the production of ion beams of elements required for ISOLDE experiments. ... laser ionization is required to be only an element-selective process"} \url{http://iopscience.iop.org/article/10.1088/1361-6471/aa78e0}

\bigskip


Magnets....

\bigskip

Ebis: charge breader: release beam with certain energy.


high-performance charge breeder (CB). CB based on the Electron Beam Ion Source (EBIS) technology – an EBIS Charge Breeder (ECB)


\bigskip

HIE-ISOLDE (Superconducting Linac Upgrade): Linear accelerator, HIE-linac \newline

\bigskip

Post-accelerated beams ISOLDE \url{http://iopscience.iop.org/article/10.1088/1361-6471/aa78ca}

\bigskip

ISOLDE actually uses the most protons at CERN [\textcolor{red}{ref?}].


ISOLDE \url{http://iopscience.iop.org/article/10.1088/1361-6471/aa5f03/pdf}


HIE-ISOLDE \url{http://hie-isolde-project.web.cern.ch}, technical design \url{http://cds.cern.ch/record/2635892?ln=en}, direct to doc: \url{http://cds.cern.ch/record/2635892/files/HIE-ISOLDE_TDR.pdf}

\bigskip

Very pure beam (\textcolor{red}{did we have statistics of this?})

\bigskip

PSB \url{https://home.cern/science/accelerators/proton-synchrotron-booster}

\bigskip

REX-ISOLDE \url{http://rex-isolde.web.cern.ch}

\bigskip

RILIS \url{http://rilis.web.cern.ch} and \url{http://iopscience.iop.org/article/10.1088/1361-6471/aa78e0/meta} and \url{https://www.research.manchester.ac.uk/portal/files/60831252/FULL_TEXT.PDF} and \url{https://www.sciencedirect.com/science/article/pii/S0168583X13008914?via%3Dihub}

\bigskip

MINIBALL \url{http://isolde.web.cern.ch/experiments/miniball} and \url{https://www.miniball.york.ac.uk/wiki/Main_Page}

\bigskip

ENSAR2 \url{http://www.ensarfp7.eu}

\bigskip

Beam production \url{http://tuprints.ulb.tu-darmstadt.de/4599/1/TUDthesis_Christoph%20Seiffert.pdf}

\bigskip

Test \cite{CERN-AC}, copyright: \url{https://copyright.web.cern.ch}

\bigskip

CERN Document Server  \url{https://cds.cern.ch}


\subsection{Target}

\Pb\ was chosen as a target. Want high $Z$ so that the probability of excitation is high. Not enough beam energy to excite \Pb. \newline

Highest $Z$ for maximum excitation probability.


Contamination... finger print [\textcolor{red}{picture}]


\section{Miniball}

Pictures \url{https://cds.cern.ch/record/844871?ln=en}

\subsection{Particle detector, DSSSD (CD)}

DSSSD: Double sided silicon strip detector

16 rings, 12 strips effectively (24 strips, 12 pairs with two strips making a pair)

Rings = annular strips, strips = radial strips or sector strips

CD distance: 26.98 mm, Inner angle (min): 9 mm, Outer angle (max): 40.9 mm

Angle coverage: [18.4$^\circ$, 56.6$^\circ$]

See \autoref{tab:CD_angles}

\begin{table}[ht] \centering 
\caption{CD angles in laboratory frame. Adjacent (CD distance): 26.98 mm.}
\label{tab:CD_angles}
\begin{tabular}{cccc}
\hline
Ring & Opposite (mid ring) & Angle [degrees] \\
\hline
0    &       40             & 56.0  \\
1    &       38             & 54.6  \\
2    &       36             & 53.1  \\
3    &       34             & 51.6  \\
4    &       32             & 49.9  \\
5    &       30             & 48.0  \\
6    &       28             & 46.1  \\
7    &       26             & 43.9  \\
8    &       24             & 41.7  \\
9    &       22             & 39.2  \\
10   &       20             & 36.5  \\
11   &       18             & 33.7  \\
12   &       16             & 30.7  \\
13   &       14             & 27.4  \\
14   &       12             & 24.0  \\
15   &       10             & 20.3  \\
\hline
\end{tabular}
\end{table}

\textcolor{red}{Vis en figur av trekanten?} 

\begin{align*}
	\theta = \tan^{-1} \left( \frac{\text{opposite}}{\text{adjacent}} \right)
\end{align*}

\subsection{\texorpdfstring{$\gamma$}{Gamma} detectors, HPGe}

24 six-fold segmented. 8 clusters of 3 crystals each. Each crystal segmented in 6 parts (144 segments in total).

\bigskip

Cryo-modules

\section{Experimental setup}
\Sm ~Coulomb excitation experiment.

Experiment code: IS558 

Ta: tantalum (Z = 73)

Sm: samarium (Z = 62)

Pb: lead (Z = 82) \newline



Beam: \Sm (T$_{1/2} \approx 15$ min, 4.65 MeV/$u$, total 651 MeV), excellent purity

Target: \Pb (Thickness: 1.4 mg/cm$^2$)


Small angle: Forward scattering: Larger distance, weaker \textcolor{red}{EM}-field, less excitation probability.

Large angle: Backward scattering: Closer distance, stronger \textcolor{red}{EM}-field, higher excitation probability. \newline


\bigskip

Expect to measure transition probabilities $B(E2)$ and quadrupole moment (nuclear deformation). 

\bigskip

\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Drawings/Coulex-ISOLDE.png}
	\caption{Coulex setup at ISOLDE. Adapted from Malin Klintefjord's PhD thesis  \cite{Klintefjord}.}
	\label{fig:Coulex}
\end{figure}


Level scheme (from Klintefjord?)

% ----------------------------------------------------------------------------------------------------------------------% ----------------------------------------------------------------------------------------------------------------------



\chapter{Data analysis} 

ROOT: analysere data

kinsim3 \url{https://github.com/lpgaff/kinsim} + SRIM \url{http://www.srim.org}

\bigskip


\begin{table}[H] \centering 
\caption{Computer used for data analysis}
\label{tab:PC}
\begin{tabular}{ll}
\hline
Model & MacBook Air (13-inch, 2017) \\
\hline
Processor & 1.8 GHz (Intel Core i5) \\
Memory & 8 GB (1600 MHz DDR3) \\
\hline
\end{tabular}
\end{table}

Run time for sorting data: \newline
TreeBuilder (online calibration): $\sim$ 40-45 min \newline
AQ4Sort (online calibration): $\sim$ 120 min

\begin{table}[H] \centering 
\caption{Run time for sorting data.}
\label{tab:run_time}
\begin{tabular}{ll}
\hline
Executable & Run time [min] \\
\hline
TreeBuilder & $\sim$ 45 \\
AQ4Sort & $\sim$ 120 \\
\hline
\end{tabular}
\end{table}

The run time of the bash script was done with the built in script time

\begin{lstlisting}[language=sh]
$ time ./AQ4S.sh Sm online TB
...
real	45m19.265s
user	42m49.653s
sys	0m39.665s
\end{lstlisting}


\begin{lstlisting}[language=sh]
$ time ./AQ4S.sh Sm online Q4
...
real	121m40.830s
user	116m18.361s
sys	1m17.809s
\end{lstlisting}


\begin{lstlisting}[language=sh]
$ time ./AQ4S.sh Sm user TB
...
real	41m11.282s
user	39m45.592s
sys	0m27.777s
\end{lstlisting}


\begin{lstlisting}[language=sh]
$ time ./AQ4S.sh Sm user Q4
...
real	143m47.600s
user	128m6.174s
sys	1m50.921s
\end{lstlisting}


\bigskip

particle-gamma and particle-gamma-gamma coincidence

\textcolor{red}{sjekk opp om energi fra online kalibrering passer med simuleringen.}

\section{Data and sorting}
The analysis code for Miniball data is named MiniballCoulexSort and is available on GitHub at \url{https://github.com/Miniball/MiniballCoulexSort}. 
The main steps of how to download, install and use it is outlined in the README.md file in the GitHub repository. 

Data from Miniball comes in the form of .med-files (Miniball Event Data). 
In order to analyze this data in ROOT\footnote{ROOT is a data analysis framework made at CERN.} the first part of the sorting is just to convert the .med-files into .root-files with the script MedToRoot. 

To get useful information out of the converted .root-files, the Treebuilder script is used. 
The .root-file(s) and a calibration file is given to the Treebuilder so it can make event trees that can be used for analyzing the Coulomb excitation events. 

One script that is mentioned in the Miniball GitHub repository, but not showed how to use, is the AQ4Sort. It is used in the same way as the TreeBuilder script, but it sorts the histograms in another way. 
This script is used before and during the calibration of the detectors, because it gives information about every single ring and every single back strip. The one thing to note here, is that the numbering of the detector rings and strips are different from the ones used in Treebuilder. 


The histograms sorted by Treebuilder starts counting from 0 and the AQ4Sort starts counting from 1. 

The ADC spectras from the file sorted by Treebuilder have a naming convention of adc\_q\_s, where $q$ corresponds to the quadrant and $s$ corresponds to the channel. The front energy is saved in adc\_[0-3]\_[0-15] and the back energy from strips 1-12 from all 16 rings (the whole quadrant) is saved in adc\_[0-3]\_[16-27].

adc\_0\_0 in the file sorted by Treebuilder is the same as fE\_Q1\_f1 sorted by AQ4Sort. All the front detectors can be found in the Treebuilder-sorted file, but when it comes to the back detector, the single pixels from the strips are not shown. These are available through the AQ4Sort sorted file. For the front detectors the histograms adc\_[0-3]\_[0-15] and fE\_Q[1-4]\_f[1-16] are the same. For the back detectors, we have that adc\_[0-3]\_[16-27] and bE\_Q[1-4]\_b[1-12] are the same. In addition in AQ4Sort we can see the different pixels. The histograms fE\_Q[1-4]\_f[1-16]\_b[1-12] shows the front energy of quadrant 1-4 gated on ring 1-16 and back strip 1-12, while the bE\_Q[1-4]\_f[1-16]\_b[1-12] shows the same, only for the back energy. 

In the naming convention of adc\_q\_s or fE\_Qu\_fv, where $q \in [0, 1, 2, 3], s \in [0, 1, \ldots, 27]$ and $u \in [1, 2, 3, 4], v \in [1, 2, \ldots, 16]$, the $s = 0$ and $v = 1$ is the outermost ring, while $s = 15$ and $v = 16$ is the innermost ring. In our case, the innermost ring was so destroyed that we have to remove it from the data analysis.


adc\_q\_s, where $q \in [0, 1, 2, 3], s \in [0, 1, \ldots, 27]$.

$p$E\_Q$q$\_f$r$\_b$s$, where $ \in [b, f], q \in [1, 2, 3, 4], r \in [1, 2, \ldots, 16]$ and $s \in [1, 2, \ldots, 12]$. 

The adc\_[0-3]\_[16-27] or bE\_Q[1-4]\_b[1-12] are a combination of all the 16 rings of bE\_Q[1-4]f\_[1, 2, $\ldots$, 16]\_b[1-12].

Don't blame me for the naming convention, I did not write the code. I just tried to make sense of it.


\begin{table}[ht] \centering 
\caption{ADC}
\label{tab:ADC}
\begin{tabular}{cccc}
\hline
ADC   & Quadrant & Channel & Front [F] or Back [B] \\
\hline
0 - 3 &  1 - 4   &    0    &    F      \\
0 - 3 &  1 - 4   &    1    &    F      \\
0 - 3 &  1 - 4   &    2    &    F      \\
0 - 3 &  1 - 4   &    3    &    F      \\
0 - 3 &  1 - 4   &    4    &    F      \\
0 - 3 &  1 - 4   &    5    &    F      \\
0 - 3 &  1 - 4   &    6    &    F      \\
0 - 3 &  1 - 4   &    7    &    F      \\
0 - 3 &  1 - 4   &    8    &    F      \\
0 - 3 &  1 - 4   &    9    &    F      \\
0 - 3 &  1 - 4   &    10   &    F      \\
0 - 3 &  1 - 4   &    11   &    F      \\
0 - 3 &  1 - 4   &    12   &    F      \\
0 - 3 &  1 - 4   &    13   &    F      \\
0 - 3 &  1 - 4   &    14   &    F      \\
0 - 3 &  1 - 4   &    15   &    F      \\
0 - 3 &  1 - 4   &    16   &    B      \\
0 - 3 &  1 - 4   &    17   &    B      \\
0 - 3 &  1 - 4   &    18   &    B      \\
0 - 3 &  1 - 4   &    19   &    B      \\
0 - 3 &  1 - 4   &    20   &    B      \\
0 - 3 &  1 - 4   &    21   &    B      \\
0 - 3 &  1 - 4   &    22   &    B      \\
0 - 3 &  1 - 4   &    23   &    B      \\
0 - 3 &  1 - 4   &    24   &    B      \\
0 - 3 &  1 - 4   &    25   &    B      \\
0 - 3 &  1 - 4   &    26   &    B      \\
0 - 3 &  1 - 4   &    27   &    B      \\
0 - 3 &            &    28   &    Empty  \\
0 - 3 &            &    29   &    Empty  \\
0 - 3 &            &    30   &    Empty  \\
0 - 3 &  1 - 4   &    31   &    PAD    \\
  4    &             &    0     &    Ionization Chamber \\
  4    &             &    1      &    Ionization Chamber \\
\hline
\end{tabular}
\end{table}



\section{Helping scripts}
All of my scripts are available in the GitHub repository \url{https://github.com/wiggoen/MasterThesis}.

In order to not copy and paste the sorting command in the terminal for every data file, I made two bash scripts to do this. The script \textbf{M2R.sh} is using MedToRoot to take in as many files as you want, and sort it in one go. The other script is \textbf{AQ4S.sh}, which is using either AQ4Sort or Treebuilder to sort a lot of files in one go. 

I also made other helping scripts to get histograms, do fitting, comparison and calibration. 

My scripts: MultiFit.cpp, MultiPlot.cpp, ++ (python, bash,..)


\section{Simulation}
To calibrate the data, we need to know the expected energy of the centroids of the peaks. 
This was done by simulating the experiment in a program called kinsim3. The program is written by Liam Gaffney\footnote{Liam Gaffney is a fellow at ISOLDE, affiliated with MINIBALL.} and the purpose of the program is to simulate the kinematics of the experiment. 
It takes into account the Silicon dead layer. 

kinsim3 generates pdf-files of the stopping powers automatically. 
The rest of the plots are available inside the root-file. 
To get the energy simulation for each ring, the function \textbf{cd\_sim\_plots()} from the script \textbf{MultiPlot.cpp} was used. 

\bigskip


CD to target distance: 26.98 mm.


Simulation done by kinsim3

\begin{figure}[H]\centering
    \includegraphics[width=\linewidth]{../Plots/simulation/kin_140Sm_208Pb.pdf}
\end{figure}


\textbf{--- \textcolor{red}{Mail from Liam started} ---} \newline
"the source has a thickness of 1.23 mm, which needs to be factored in so that the CD to target distance is the CD to source distance PLUS the source thickness, i.e. 25.78 mm + 1.23 mm =  27.01 mm. 
This is very close to the 26.98 mm you got from us in August. 
\textcolor{red}{I think that the source data was reanalysed since the original blog entry, giving the 0.03 mm difference!}" \newline
\textbf{--- \textcolor{red}{Mail from Liam ended} ---} \newline


Terminal: Simulation: 140Sm on 208Pb:
\begin{lstlisting}[language=sh]
$ cd GitHub/Miniball/kinsim
$ root
root [0] .L kinsim3.cc+
root [1] kinsim3(62, 82, 140, 208, 1.4, 4.65, 0.02, 1.0, 0.6, 26.98, false, 1e6, "../SRIM")
\end{lstlisting}


kinsim3 function:
\begin{lstlisting}[language=c++]
void kinsim3( int Zb, int Zt, double Ab, double At, double thick /* mg/cm^2 */, double Eb /* MeV/u */,
    double dEb = 0.1 /* MeV/u */, double Ex = 1.0 /* MeV */, double res = 0.6 /* % */,
	double cd_dist = 28.0 /* mm */, bool flat = false /* angular distribution? */,
	long Nevts = 1E6, string srim_dir = "../srim" )
\end{lstlisting}

\bigskip

\textcolor{red}{Say something about SRIM files.}

\bigskip



\section{Calibration}

My goal of the calibration was to make a program that could automatically fit the plots i needed, but it became more and more manual labor. 
Because of the shape of the data peaks, it demands very much individual care. 
This I could not do with a automatic program. 
The downfall of the automatic centroid collector came when trying it on the back detectors. 

The total amount particle front detectors to calibrate is 4 quadrants * 16 rings = 64 front detectors 

back detectors: 4 quadrants * 12 strips = 48 back detectors


but to do this, one need all the centroids of the peaks from both sides:

front: 64 detectors * 2 peaks/ring = 128 centroids

back: 48 detectors * 2 peaks/ring * 16 rings =  1536 centroids 

total centroids to collect: 1664 centroids (this I did not want to do manually)

Full calibration with 16 rings and 12 back strips. We had to remove the innermost ring. 



\textcolor{red}{MOVE THE BELOW TO APPENDIX?}

For each file converted with MedToRoot, the program makes four files; OffBeam, OnBeam, OnBeamBackground and Scaler. The file we are interested in for analysis is the OnBeam file. 

First all of the interesting files are converted with the M2R.sh script. 
\begin{lstlisting}[language=sh]
$ cd /Users/trondwj/GitHub/MasterThesis/Scripts/sorting 
$ ./M2R.sh Sm
\end{lstlisting}

Then the OnBeam files from M2R.sh is run through using Treebuilder in the AQ4S.sh script. 

\begin{lstlisting}[language=sh]
$ cd /Users/trondwj/GitHub/MasterThesis/Scripts/sorting 
$ ./AQ4S.sh Sm user TB
$ mv Sm_user-TreeBuilder-2019-04-10.root ../../Sorted_data/
\end{lstlisting}


After the sorting, I moved the file to a folder of sorted data, and gave the relative path in the setup\_Sm.txt file in Scripts/plotting/ used as input in the MultiPlot.cpp script. 
Using the MultiPlot.cpp script, the ADC time offsets can be extracted by the following commands
\begin{lstlisting}[language=sh]
$ cd /Users/trondwj/GitHub/MasterThesis/Scripts/plotting
$ root
root [0] .L MultiPlot.cpp++
root [1] check_ADC_time_offsets("setup_Sm.txt")
\end{lstlisting}
or they can be manually reached by
\begin{lstlisting}[language=sh]
$ cd /Users/trondwj/GitHub/MasterThesis/Sorted_data
$ root Sm_user-TreeBuilder-2019-04-10.root
root [1] new TBrowser()
\end{lstlisting}
and in the browser, the histograms named tdiff\_gp\_\textit{i} (where \textit{i} is a number between 0 and 3) will lie under all the folders. The peaks of these plots have the interesting x-value. Zooming into the peaks, it is very clear what value it is. These values are provided in the calibration file under ADC time offsets (ticks). These values can change depending on the amount of data sorted, so it is wise to double check them.

After the peak values have been collected, they should be written into the calibration file
\begin{lstlisting}[language=sh]
# ADC time offsets (ticks)
adc_0.TimeOffset:  0
adc_1.TimeOffset:  -2
adc_2.TimeOffset:  -3
adc_3.TimeOffset:  5
\end{lstlisting}

\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/tdiff_gp_0-3-user.pdf}
	\caption{ADC time offsets.}
	\label{fig:ADC_dt}
\end{figure}




\textcolor{red}{HUSK:} Si noe om ADC time offsets + Threshold. Og at man må se på det tidlig, så resortere.


M2R.sh $\rightarrow$ AQ4S.sh$\rightarrow$ check time offset $\rightarrow$ threshold $\rightarrow$ AQ4\_fit() $\rightarrow$ particle-calibration.py $\rightarrow$  ADC\_generator.py $\rightarrow$ copy the calibration from the terminal and paste into calibration file 


Simulation fit $\rightarrow$ AQ4\_fit() $\rightarrow$ particle-calibration.py $\rightarrow$  ADC\_generator.py $\rightarrow$ copy the calibration from the terminal and paste into calibration file 

Visualize plots using ROOT and the scripts. 



Skriv om scriptene som er lagd, og at det var litt vanskelig å automatisere kalibreringen. Hvis det skulle vært gjort måtte vi funnet en funksjon med "negatively skewed distribution" or "negative skewness" (right modal), en "left skewed function" (most data is more than the mean). 


I log-skala ser dette mer Gaussisk ut, men det er ikke det i non-log skala. 


Back detector calibration: There are just too much individual differences to calibrate the back detectors with a simple script given a range for all 12 back strips. I found out this way to late. There isn't any range to rule them all, at least since the fitting function can behave very strange given a too small or too big range.



\textbf{--- \textcolor{red}{Mail from Liam begins} ---}

"You might have to investigate the threshold a little bit. The continuum of events at low energy comes from charge sharing between the strips. For these very heavy ions, the total amount of charge deposited gets split between neighbouring strips of the CD. The code does performs some tricks to try and recover the correct energy and position, but that depends on counting the number of strips that fire. Therefore, if the threshold is too low you will include "pedestal" events and it will get things wrong. If the threshold is too high, you will miss some events that have charge sharing and get the wrong energy for your particle. 

The key spectra to look at are "part" and "cd\_debug". The latter counts how many particles have X strips fired on the front side and Y strips fired on the back side.

If you have too many cd\_debug events = 3, then your thresholds are too low. If you have a large continuum/background in the "part" spectrum, your thresholds are too high. Best thing to do is play about with different values.

Bin 20 is when no particle can be found, because there is no energy registered in either the front or the back strips. This can only happen when the front energy is below the software threshold that you set and the back energy is either in a broken strip or is also below the software threshold. Likely it is some noise events or charge sharing that comes below the threshold.

\textcolor{red}{The major problem with the online calibration is that a number of the back strips have the wrong gains}, but it otherwise looks quite good. Have you identified which strips these are, by comparing the gains between the 'online' and 'user' calibrations? You could maybe correct those strips as an intermediate step and see how things look.

the source has a thickness of 1.23 mm, which needs to be factored in so that the CD to target \textcolor{red}{distance is the CD} to source distance PLUS the source thickness, i.e. 25.78 mm + 1.23 mm =  27.01 mm. This is very close to the 26.98 mm you got from us in August. I think that the source data was reanalyzed since the original blog entry, giving the 0.03 mm difference!"

\textbf{--- \textcolor{red}{Mail from Liam ended} ---}



\textbf{Pedestal}

The pedestal is like a massive statue in front of the interesting data. 


We use a threshold to cut away the pedestal.

\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/Pedestal_Q1_f1.pdf}
	\caption{Pedestal Q1, f6.}
	\label{fig:Pedestal_f}
\end{figure}

\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/Pedestal_Q1_b1.pdf}
	\caption{Pedestal Q1, f6.}
	\label{fig:Pedestal_b}
\end{figure}



\textbf{Threshold}

* Threshold (forskjellig i log/ikke-log skala)

Using a logarithmic y-axis, the threshold value will decrease very much. So don't use that. 

Threshold: The code has a default threshold of 100, but in some cases this is too much and some cases this is not enough. So for each adc channel, the threshold can be set. We don't want to include the "pedestal". Charge sharing.
Won't cut too much or too little..

\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/Threshold_Q1_f6.pdf}
	\caption{Threshold Q1, f6.}
	\label{fig:Threshold_f}
\end{figure}

\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/Threshold_Q1_b6.pdf}
	\caption{Threshold Q1, b6.}
	\label{fig:Threshold_b}
\end{figure}



\textbf{CD debug:}

\begin{lstlisting}[language=sh]
$ cd /Users/trondwj/GitHub/MasterThesis/Scripts/plotting 
$ root
root [0] .L MultiPlot.cpp++
root [1] check_cd_debug("setup_Sm.txt")
\end{lstlisting}


\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/cd_debug-user.pdf}
	\caption{CD debugging.}
	\label{fig:CD_debug}
\end{figure}


\subsection{Particle detector}


\subsubsection{User calibration}
ADC: Analog to digital converter (Mesytec)

TDC: Time to digital converter

DSSSD: Double-Sided Silicon Strip Detector $\implies$ CD

must remove the inner ring from data analysis because of damage

\begin{align*}
	\text{gain} = \frac{E_{\text{Sm}} - E_{\text{Pb}}}{Ch_{\text{Sm}} - Ch_{\text{Pb}}}
\end{align*}

\begin{align*}
	\text{offset} = E_{\text{Sm}} - \text{gain} \cdot Ch_{\text{Sm}}
\end{align*}
in keV.

\textcolor{red}{Hvis man har flere sentroider bruker man bare lineær regresjon. Gjelder spesielt for baksiden!}

\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/E_f_b_Q1-4-user-new-cal.pdf}
	\caption{User calibration.}
	\label{fig:cal_user}
\end{figure}



\subsubsection{Online calibration}


\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{../Plots/plotting/E_f_b_Q1-4-online.pdf}
	\caption{Online calibration.}
	\label{fig:cal_online}
\end{figure}



\subsection{Gamma detectors}

DGF: Digital \ga~ finder

addback, singles, ...


\section{Doppler correction}

% ----------------------------------------------------------------------------------------------------------------------% ----------------------------------------------------------------------------------------------------------------------


\chapter{Experimental results}


% ----------------------------------------------------------------------------------------------------------------------% ----------------------------------------------------------------------------------------------------------------------


\chapter{Discussion}


% ----------------------------------------------------------------------------------------------------------------------% ----------------------------------------------------------------------------------------------------------------------

\chapter{Summary and outlook}

GOSIA and GOSIA2 analysis?

\url{https://www.pas.rochester.edu/~cline/Gosia/Gosia_Manual_20110609.pdf}

% ----------------------------------------------------------------------------------------------------------------------% ----------------------------------------------------------------------------------------------------------------------




% ----------------------------------------------------------------------------------------------------------------------% ----------------------------------------------------------------------------------------------------------------------

\begin{appendices}
\chapter{Connecting MiniballCoulexSort with ROOT}
To connect MiniballCoulexSort with ROOT you need them to share their libraries with each other. This is done with a dynamic loader. You can find out more here: \url{https://root.cern.ch/root/htmldoc/guides/users-guide/ROOTUsersGuide.html#file-system.rootrc}. 

You have to make a \textbf{.rootrc} file in your home folder on your computer. In the \textbf{.rootrc} file you want to write something like this 
\begin{lstlisting}[language=sh]
Unix.*.Root.DynamicPath:    .:</Users/trondwj/GitHub/ROOT-framework/build/lib>:/Users/trondwj/GitHub/Miniball/MiniballCoulexSort/lib:
\end{lstlisting}
This should all be in one line. The first part is to tell the system to use the dynamic loader of ROOT to connect the given paths that follow. In my case the lib folder of the ROOT install was at 
\begin{lstlisting}[language=sh]
/Users/trondwj/GitHub/ROOT-framework/build/lib
\end{lstlisting}
and the lib folder of the MiniballCoulexSort was at
\begin{lstlisting}[language=sh]
/Users/trondwj/GitHub/Miniball/MiniballCoulexSort/lib
\end{lstlisting}
These paths is totally individual, and you will probably not have it in the same place. Therefore these paths must be changed to fit your system. 

After making the file you either have restart the terminal or you can source the file by writing this in the terminal
\begin{lstlisting}[language=sh]
$ source ~/.rootrc
\end{lstlisting}


\chapter{Running ROOT and MiniballCoulexSort from anywhere in the terminal}
To run ROOT or the different scripts of MiniballCoulexSort anywhere in the terminal, you have to edit your \textbf{.bash\_profile} file [.bash\_profile on MacOS, .bashrc on Linux]. In my \textbf{.bash\_profile} I used this 
\begin{lstlisting}[language=sh]
# Run ROOT from anywhere
export ROOTSYS=$HOME/GitHub/ROOT-framework/build
export PATH=$ROOTSYS/lib:$PATH
export PATH=$ROOTSYS/bin:$PATH
export DYLD_LIBRARY_PATH=$ROOTSYS/lib:$DYLD_LIBRARY_PATH

# Run MiniballCoulexSort from anywhere
export DYLD_LIBRARY_PATH=$HOME/GitHub/Miniball/MiniballCoulexSort/lib:$DYLD_LIBRARY_PATH
export PATH=$HOME/GitHub/Miniball/MiniballCoulexSort/lib:$PATH
export PATH=$HOME/GitHub/Miniball/MiniballCoulexSort/bin:$PATH
\end{lstlisting}
The DYLD\_LIBRARY\_PATH is used on Mac only. On other systems, use \newline LD\_LIBRARY\_PATH. You need to locate the lib and bin folders for both ROOT and MiniballCoulexSort and change them to fit your system, and in addition you need the build folder of your ROOT install.



\chapter{Other appendicies}
\includepdf[pages={-}, angle=270]{../Plots/simulation/cd_sim_all.pdf}


\end{appendices}



%\bibliographystyle{unsrtnat}
\bibliographystyle{mybibstyle} %my own bibstyle to set first names to one letter + unsrtnat

\bibliography{/Users/trondwj/GitHub/MasterThesis/Thesis/Mendeley/Miniball.bib,/Users/trondwj/GitHub/MasterThesis/Thesis/References/web_references.bib}


\end{document}